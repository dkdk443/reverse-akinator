< !DOCTYPE html >
  <html lang="ja">
    <head>
      <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Reverse Akinator</title>
          <script src="https://cdn.tailwindcss.com"></script>
          <script src="https://unpkg.com/lucide@latest"></script>
          <style>
            .scrollbar-hide::-webkit-scrollbar {display: none; }
            .scrollbar-hide {-ms - overflow - style: none; scrollbar-width: none; }
          </style>
        </head>
        <body class="bg-slate-50 text-slate-800 h-screen flex flex-col font-sans overflow-hidden">

          <!-- Header -->
          <header class="flex-shrink-0 bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between shadow-sm z-10">
            <div class="flex items-center gap-2">
              <i data-lucide="brain-circuit" class="text-indigo-600"></i>
              <div>
                <h1 class="text-lg font-bold text-slate-900 leading-tight">Reverse Akinator</h1>
                <p class="text-[10px] text-slate-500">History Mystery</p>
              </div>
            </div>
            <div id="game-stats" class="hidden flex items-center gap-2 text-sm font-medium text-slate-600">
              <button onclick="askHint()" id="btn-hint" class="bg-amber-100 text-amber-700 p-2 rounded-full hover:bg-amber-200 transition-colors">
                <i data-lucide="lightbulb" class="w-4 h-4"></i>
              </button>
              <span class="bg-slate-100 px-2 py-1 rounded-full text-xs">Q: <span id="q-count">0</span></span>
              <button onclick="showGuessModal()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-full hover:bg-indigo-700 text-xs flex items-center gap-1">
                <i data-lucide="check-circle-2" class="w-3 h-3"></i> 回答
              </button>
            </div>
          </header>

          <!-- Main Content -->
          <main class="flex-1 overflow-hidden relative flex flex-col">
            <!-- Start Screen -->
            <div id="start-screen" class="absolute inset-0 z-20 flex flex-col items-center justify-center p-6 bg-slate-50 text-center">
              <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mb-6 text-indigo-600 animate-bounce">
                <i data-lucide="brain-circuit" class="w-10 h-10"></i>
              </div>
              <h2 class="text-2xl font-bold text-slate-900 mb-2">私は誰でしょう？</h2>
              <p class="text-slate-600 text-sm mb-8">歴史上の人物を当ててください。<br>AI機能＆年代絞り込み対応。</p>
              <button onclick="startGame()" class="bg-indigo-600 text-white py-3 px-8 rounded-xl font-bold shadow-lg hover:bg-indigo-700 flex items-center gap-2">
                <i data-lucide="play" class="w-5 h-5"></i> スタート
              </button>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="hidden absolute inset-0 z-30 flex flex-col items-center justify-center p-6 bg-slate-900/90 text-white text-center backdrop-blur-sm">
              <div id="result-icon" class="w-20 h-20 rounded-full flex items-center justify-center mb-6 bg-green-500">
                <i data-lucide="sparkles" class="w-10 h-10"></i>
              </div>
              <h2 id="result-title" class="text-3xl font-bold mb-2">正解！</h2>
              <p id="result-msg" class="text-slate-300 mb-6"></p>
              <div class="bg-white/10 p-5 rounded-xl mb-8 w-full max-w-sm border border-white/20">
                <p class="text-xs text-slate-400 uppercase mb-1">Target Person</p>
                <h3 id="result-name" class="text-xl font-bold"></h3>
                <p id="result-name-en" class="text-slate-300 text-xs"></p>
              </div>
              <button onclick="startGame()" class="bg-white text-indigo-900 py-2 px-6 rounded-full font-bold shadow-lg hover:bg-indigo-50 flex items-center gap-2">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i> 再挑戦
              </button>
            </div>

            <!-- Chat Area -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 bg-slate-50 scroll-smooth pb-32">
              <!-- Messages injected here -->
            </div>

            <!-- Controls -->
            <div id="controls" class="hidden absolute bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg z-10">
              <!-- Tabs -->
              <div class="flex overflow-x-auto py-2 px-2 border-b border-slate-100 scrollbar-hide gap-1" id="category-tabs">
                <!-- Tabs injected by JS -->
              </div>

              <!-- Interaction Area -->
              <div class="p-3 h-48 bg-slate-50/50">
                <!-- Preset Questions -->
                <div id="preset-area" class="grid grid-cols-1 gap-2 overflow-y-auto h-full pr-1 hidden"></div>

                <!-- Year Input -->
                <div id="year-area" class="hidden h-full flex flex-col items-center justify-center p-4">
                  <p class="text-sm text-slate-500 mb-3">西暦を入力して絞り込み</p>
                  <div class="flex items-center gap-2 w-full max-w-xs mb-3">
                    <input type="number" id="year-input" placeholder="例: 1600" class="flex-1 p-2 border rounded-lg text-center" value="1600">
                      <span class="text-sm">年</span>
                  </div>
                  <div class="flex gap-2 w-full max-w-xs">
                    <button onclick="askYear('before')" class="flex-1 bg-blue-100 text-blue-700 py-2 rounded-lg hover:bg-blue-200 text-sm font-bold">より前</button>
                    <button onclick="askYear('after')" class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg hover:bg-red-200 text-sm font-bold">より後</button>
                  </div>
                </div>

                <!-- Custom Input -->
                <div id="custom-area" class="hidden h-full flex flex-col items-center justify-center p-2">
                  <p class="text-xs text-slate-500 mb-2 flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3 text-indigo-500"></i> AIに自由に質問</p>
                  <div class="flex gap-2 w-full max-w-md">
                    <input type="text" id="custom-input" placeholder="質問を入力..." class="flex-1 p-2 border border-slate-300 rounded-lg text-sm">
                      <button onclick="askCustom()" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700"><i data-lucide="send" class="w-4 h-4"></i></button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Guess Modal -->
            <div id="guess-modal" class="hidden absolute inset-0 z-40 bg-slate-900/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
              <div class="bg-white w-full max-w-md p-4 rounded-t-2xl sm:rounded-2xl flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="font-bold">回答する</h3>
                  <button onclick="closeGuessModal()" class="p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="overflow-y-auto flex-1 mb-4 border rounded-lg">
                  <div id="person-list" class="divide-y divide-slate-100"></div>
                </div>
              </div>
            </div>
          </main>

          <script>
        // --- Config & Data ---
            const apiKey = ""; // APIキーを設定

            // year: 活動の目安となる西暦
            const PERSONS = [
            {id: 1, name: '織田信長', year: 1560, attributes: {region: 'japan', era: 'sengoku', gender: 'male', occupation: 'warrior' } },
            {id: 2, name: '豊臣秀吉', year: 1585, attributes: {region: 'japan', era: 'sengoku', gender: 'male', occupation: 'warrior' } },
            {id: 3, name: '徳川家康', year: 1600, attributes: {region: 'japan', era: 'edo', gender: 'male', occupation: 'politician' } },
            {id: 4, name: '坂本龍馬', year: 1860, attributes: {region: 'japan', era: 'bakumatsu', gender: 'male', occupation: 'warrior' } },
            {id: 6, name: '夏目漱石', year: 1900, attributes: {region: 'japan', era: 'modern_jp', gender: 'male', occupation: 'writer' } },
            {id: 9, name: '紫式部', year: 1000, attributes: {region: 'japan', era: 'ancient', gender: 'female', occupation: 'writer' } },
            {id: 15, name: '手塚治虫', year: 1970, attributes: {region: 'japan', era: 'modern', gender: 'male', occupation: 'artist' } },
            {id: 16, name: 'ナポレオン', year: 1804, attributes: {region: 'europe', era: 'modern_world', gender: 'male', occupation: 'warrior' } },
            {id: 17, name: 'クレオパトラ', year: -30, attributes: {region: 'other', era: 'ancient', gender: 'female', occupation: 'politician' } },
            {id: 18, name: 'ダ・ヴィンチ', year: 1500, attributes: {region: 'europe', era: 'medieval', gender: 'male', occupation: 'artist' } },
            {id: 20, name: 'アインシュタイン', year: 1920, attributes: {region: 'europe', era: 'modern', gender: 'male', occupation: 'scientist' } },
            {id: 21, name: 'マリー・キュリー', year: 1910, attributes: {region: 'europe', era: 'modern', gender: 'female', occupation: 'scientist' } },
            {id: 22, name: 'ガンディー', year: 1940, attributes: {region: 'asia', era: 'modern', gender: 'male', occupation: 'politician' } },
            {id: 26, name: 'ピカソ', year: 1950, attributes: {region: 'europe', era: 'modern', gender: 'male', occupation: 'artist' } },
            {id: 28, name: 'リンカーン', year: 1860, attributes: {region: 'america', era: 'modern_world', gender: 'male', occupation: 'politician' } }
            ];

            const CATEGORIES = [
            {id: 'custom', name: '自由', icon: 'message-square', color: 'text-indigo-600 bg-indigo-50' },
            {id: 'year', name: '年代', icon: 'calendar-clock', color: 'text-rose-600 bg-rose-50' }, // 新設
            {id: 'region', name: '地域', icon: 'globe', color: 'text-blue-600 bg-blue-50' },
            {id: 'gender', name: '性別', icon: 'user', color: 'text-pink-600 bg-pink-50' },
            {id: 'occupation', name: '職業', icon: 'briefcase', color: 'text-emerald-600 bg-emerald-50' }
            ];

            const QUESTIONS = [
            {id: 11, categoryId: 'region', text: '日本人ですか？', check: (p) => p.attributes.region === 'japan' },
            {id: 12, categoryId: 'region', text: 'ヨーロッパの人ですか？', check: (p) => p.attributes.region === 'europe' },
            {id: 13, categoryId: 'region', text: 'アメリカの人ですか？', check: (p) => p.attributes.region === 'america' },
            {id: 21, categoryId: 'gender', text: '男性ですか？', check: (p) => p.attributes.gender === 'male' },
            {id: 22, categoryId: 'gender', text: '女性ですか？', check: (p) => p.attributes.gender === 'female' },
            {id: 31, categoryId: 'occupation', text: '武将・軍人ですか？', check: (p) => p.attributes.occupation === 'warrior' },
            {id: 32, categoryId: 'occupation', text: '政治家ですか？', check: (p) => p.attributes.occupation === 'politician' },
            {id: 33, categoryId: 'occupation', text: '芸術家・作家ですか？', check: (p) => ['artist', 'writer'].includes(p.attributes.occupation) },
            {id: 34, categoryId: 'occupation', text: '科学者ですか？', check: (p) => p.attributes.occupation === 'scientist' }
            ];

            // --- State ---
            let targetPerson = null;
            let qCount = 0;
            let currentCat = 'custom';

            // --- Core Functions ---
            function init() {
              lucide.createIcons();
            renderTabs();
            renderPersonList();
        }

            function startGame() {
              targetPerson = PERSONS[Math.floor(Math.random() * PERSONS.length)];
            console.log("Target:", targetPerson.name); // Debug
            qCount = 0;
            updateStats();
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('game-stats').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('chat-container').innerHTML = '';
            addMessage('ai', '歴史上の人物を思い浮かべました。質問してください。', 'neutral');
            switchTab('year');
        }

            function addMessage(type, text, highlight) {
            const div = document.createElement('div');
            const isAi = type === 'ai';
            const colorClass = highlight === 'yes' ? 'bg-green-50 border-green-200' :
            highlight === 'no' ? 'bg-red-50 border-red-200' : 'bg-white border-slate-200';

            div.className = `flex w-full mb-3 ${isAi ? 'justify-start' : 'justify-end'}`;
            div.innerHTML = `
            <div class="flex max-w-[85%] ${isAi ? 'flex-row' : 'flex-row-reverse'} items-end gap-2">
              <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${isAi ? 'bg-indigo-600 text-white' : 'bg-gray-300'}">
                <i data-lucide="${isAi ? 'brain-circuit' : 'user'}" class="w-4 h-4"></i>
              </div>
              <div class="p-3 rounded-2xl shadow-sm border text-sm ${isAi ? colorClass : 'bg-indigo-600 text-white'}">
                ${text}
              </div>
            </div>`;
            document.getElementById('chat-container').appendChild(div);
            lucide.createIcons();
            div.scrollIntoView({behavior: 'smooth' });
        }

            function updateStats() {
              document.getElementById('q-count').innerText = qCount;
        }

            // --- Logic: Questions ---
            function handleAsk(text, isYes) {
              qCount++;
            updateStats();
            addMessage('user', text, 'neutral');
            setTimeout(() => {
                const ans = isYes ? 'はい' : 'いいえ';
            addMessage('ai', ans, isYes ? 'yes' : 'no');
            }, 500);
        }

            // 年代質問
            function askYear(type) {
            const inputVal = parseInt(document.getElementById('year-input').value);
            if (!inputVal) return;

            const text = `西暦${inputVal}年より${type === 'before' ? '前' : '後'}ですか？`;
            // ロジック: beforeなら (target < input) が正解ならYes
            let isYes = false;
            if (type === 'before') isYes = targetPerson.year < inputVal;
            else isYes = targetPerson.year > inputVal;

            handleAsk(text, isYes);
        }

            // プリセット質問
            function askPreset(qId) {
            const q = QUESTIONS.find(x => x.id === qId);
            handleAsk(q.text, q.check(targetPerson));
        }

            // 自由質問 (Gemini)
            async function askCustom() {
            const input = document.getElementById('custom-input');
            const text = input.value.trim();
            if(!text) return;
            input.value = '';

            qCount++;
            updateStats();
            addMessage('user', text, 'neutral');

            // 簡易ローディング
            const loadId = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = loadId;
            div.className = "text-xs text-slate-400 ml-12 mb-2";
            div.innerText = "考え中...";
            document.getElementById('chat-container').appendChild(div);

            try {
                const prompt = `正解は「${targetPerson.name}」です。ユーザーの質問「${text}」に「はい」「いいえ」「どちらとも言えない」のいずれかで答えて。正解は隠して。`;
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
              method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({contents: [{parts: [{text: prompt }] }] })
                });
            const data = await res.json();
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "エラー";

            document.getElementById(loadId).remove();

            let hl = 'neutral';
            if(reply.includes('はい')) hl = 'yes';
            if(reply.includes('いいえ')) hl = 'no';
            addMessage('ai', reply, hl);
            } catch(e) {
              document.getElementById(loadId).remove();
            addMessage('ai', '通信エラーです', 'neutral');
            }
        }

            // ヒント (Gemini)
            async function askHint() {
            const btn = document.getElementById('btn-hint');
            btn.disabled = true;
            addMessage('user', 'ヒントをください', 'neutral');

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
              method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({contents: [{parts: [{text: `正解は「${targetPerson.name}」です。正解を明かさず面白いヒントを日本語で1つ出して。` }] }] })
                });
            const data = await res.json();
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "ヒント生成失敗";
            addMessage('ai', `ヒント: ${reply}`, 'neutral');
            } catch(e) {console.log(e); }
            btn.disabled = false;
        }

            // --- UI Control ---
            function renderTabs() {
            const container = document.getElementById('category-tabs');
            container.innerHTML = CATEGORIES.map(c => `
            <button onclick="switchTab('${c.id}')"
              class="tab-btn px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition-all border ${c.id === currentCat ? c.color + ' border-current' : 'text-slate-500 border-transparent hover:bg-slate-50'}"
              data-id="${c.id}">
              <i data-lucide="${c.icon}" class="w-4 h-4"></i> ${c.name}
            </button>
            `).join('');
            lucide.createIcons();
        }

            function switchTab(catId) {
              currentCat = catId;
            renderTabs();
            
            ['preset-area', 'year-area', 'custom-area'].forEach(id => document.getElementById(id).classList.add('hidden'));

            if (catId === 'custom') {
              document.getElementById('custom-area').classList.remove('hidden');
            } else if (catId === 'year') {
              document.getElementById('year-area').classList.remove('hidden');
            } else {
                // Preset
                const area = document.getElementById('preset-area');
            area.classList.remove('hidden');
                area.innerHTML = QUESTIONS.filter(q => q.categoryId === catId).map(q => `
            <button onclick="askPreset(${q.id})" class="text-left p-3 border rounded-lg hover:bg-indigo-50 hover:border-indigo-200 text-sm transition-colors bg-white">
              ${q.text}
            </button>
            `).join('');
            }
        }

            // --- Guessing Logic ---
            function showGuessModal() {
              document.getElementById('guess-modal').classList.remove('hidden');
        }
            function closeGuessModal() {
              document.getElementById('guess-modal').classList.add('hidden');
        }
            function renderPersonList() {
            // ID順ソート
            const sorted = [...PERSONS].sort((a,b) => a.id - b.id);
            document.getElementById('person-list').innerHTML = sorted.map(p => `
            <button onclick="makeGuess(${p.id})" class="w-full text-left p-3 hover:bg-indigo-50 flex justify-between items-center group">
              <span class="font-medium text-slate-700">${p.name}</span>
              <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 group-hover:text-indigo-500"></i>
            </button>
            `).join('');
            lucide.createIcons();
        }
            function makeGuess(id) {
              closeGuessModal();
            const guess = PERSONS.find(p => p.id === id);
            if (guess.id === targetPerson.id) {
              // Win
              document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('result-title').innerText = "正解！";
            document.getElementById('result-icon').className = "w-20 h-20 rounded-full flex items-center justify-center mb-6 bg-green-500 text-white";
            document.getElementById('result-msg').innerText = `${qCount}回の質問で正解しました。`;
            document.getElementById('result-name').innerText = targetPerson.name;
            } else {
              // Lose (Instant Game Over style or just Continue? -> Akinator usually continues, but here let's Game Over for simplicity or just message)
              // 今回は「不正解」メッセージを出して続行させるパターンにします（アキネーターっぽく）
              qCount++;
            updateStats();
            addMessage('user', `${guess.name}ですか？`, 'neutral');
            addMessage('ai', '違います。まだ諦めないでください。', 'no');
            }
        }

            // Init
            init();
          </script>
        </body>
      </html>