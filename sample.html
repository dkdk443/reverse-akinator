<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reverse Akinator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Custom Scrollbar for Result Modal */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

  </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex flex-col font-sans overflow-hidden">

  <!-- Header -->
  <header
    class="flex-shrink-0 bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between shadow-sm z-10">
    <div class="flex items-center gap-2">
      <i data-lucide="brain-circuit" class="text-indigo-600"></i>
      <div>
        <h1 class="text-lg font-bold text-slate-900 leading-tight">Reverse Akinator</h1>
        <p class="text-[10px] text-slate-500">History Mystery</p>
      </div>
    </div>
    <div id="game-stats" class="hidden flex items-center gap-3 text-sm font-medium text-slate-600">
      <!-- Hint Button -->
      <button onclick="askHint()" id="btn-hint"
        class="group flex items-center gap-1.5 bg-amber-50 text-amber-700 px-3 py-1.5 rounded-full border border-amber-200 hover:bg-amber-100 hover:border-amber-300 transition-all shadow-sm active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:active:scale-100 disabled:hover:bg-amber-50">
        <i data-lucide="lightbulb" class="w-3.5 h-3.5 fill-amber-400 text-amber-600"></i>
        <span class="text-xs font-bold">ヒント</span>
        <span id="hint-badge"
          class="bg-amber-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[1.2em] text-center">3</span>
      </button>

      <span class="bg-slate-100 px-3 py-1.5 rounded-full text-xs border border-slate-200">Q: <span id="q-count"
          class="font-bold">0</span></span>

      <button onclick="showGuessModal()"
        class="bg-indigo-600 text-white px-3 py-1.5 rounded-full hover:bg-indigo-700 text-xs flex items-center gap-1 shadow-sm hover:shadow active:scale-95 transition-all">
        <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i> 回答
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 overflow-hidden relative flex flex-col">
    <!-- Start Screen -->
    <div id="start-screen"
      class="absolute inset-0 z-20 flex flex-col items-center justify-center p-6 bg-slate-50 text-center">
      <div
        class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mb-6 text-indigo-600 animate-bounce">
        <i data-lucide="brain-circuit" class="w-10 h-10"></i>
      </div>
      <h2 class="text-2xl font-bold text-slate-900 mb-2">私は誰でしょう？</h2>
      <p class="text-slate-600 text-sm mb-8">歴史上の人物を当ててください。<br>AI機能＆年代絞り込み対応。</p>
      <button onclick="startGame()"
        class="bg-indigo-600 text-white py-3 px-8 rounded-xl font-bold shadow-lg hover:bg-indigo-700 flex items-center gap-2 transform transition hover:scale-105">
        <i data-lucide="play" class="w-5 h-5"></i> スタート
      </button>
    </div>

    <!-- Result Screen (Redesigned) -->
    <div id="result-screen"
      class="hidden absolute inset-0 z-30 flex flex-col items-center justify-center bg-slate-900/80 backdrop-blur-sm overflow-hidden p-4">
      <div
        class="bg-white text-slate-800 rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-full animate-[fadeIn_0.5s_ease-out]">

        <!-- Header Area -->
        <div class="bg-indigo-600 p-6 text-center relative shrink-0">
          <div id="result-icon"
            class="w-20 h-20 mx-auto bg-white rounded-full flex items-center justify-center shadow-lg mb-3 text-indigo-600 ring-4 ring-indigo-400/50">
            <i data-lucide="crown" class="w-10 h-10"></i>
          </div>
          <div class="mb-1">
            <span
              class="text-indigo-200 text-xs font-bold uppercase tracking-widest border border-indigo-400/50 px-2 py-0.5 rounded-full">正解</span>
          </div>
          <h1 id="result-name" class="text-3xl md:text-4xl font-black text-white mb-1 tracking-tight drop-shadow-sm">
          </h1>
          <p id="result-name-en" class="text-indigo-200 text-sm font-medium tracking-wide mb-4"></p>

          <!-- Catchphrase -->
          <div id="result-catchphrase"
            class="inline-block bg-yellow-400 text-yellow-900 text-xs md:text-sm font-bold px-4 py-1.5 rounded-full shadow-lg transform -rotate-1 border border-yellow-300">
          </div>
        </div>

        <!-- Scrollable Content -->
        <div class="p-5 md:p-6 overflow-y-auto custom-scrollbar bg-slate-50">

          <!-- Basic Info Grid -->
          <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
              <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">生没年</p>
              <p id="result-years" class="font-bold text-sm text-slate-700"></p>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
              <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">職業・身分</p>
              <p id="result-occupation" class="font-bold text-sm text-slate-700"></p>
            </div>
          </div>

          <!-- Achievement -->
          <div class="mb-6 relative">
            <h3 class="flex items-center gap-2 text-sm font-bold text-slate-800 mb-2">
              <i data-lucide="trophy" class="w-4 h-4 text-amber-500"></i> 主要な功績
            </h3>
            <div
              class="bg-amber-50 p-4 rounded-xl border border-amber-100 text-sm text-slate-700 leading-relaxed shadow-sm">
              <p id="result-achievement"></p>
            </div>
          </div>

          <!-- Quote & Personality -->
          <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div>
              <h3 class="flex items-center gap-2 text-sm font-bold text-slate-800 mb-2">
                <i data-lucide="message-circle" class="w-4 h-4 text-indigo-500"></i> 名言
              </h3>
              <blockquote
                class="relative p-4 text-sm italic text-slate-600 border-l-4 border-indigo-300 bg-white rounded-r-lg shadow-sm">
                <span id="result-quote"></span>
              </blockquote>
            </div>
            <div>
              <h3 class="flex items-center gap-2 text-sm font-bold text-slate-800 mb-2">
                <i data-lucide="smile" class="w-4 h-4 text-pink-500"></i> 性格・特徴
              </h3>
              <p id="result-personality"
                class="text-sm text-slate-600 leading-relaxed bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
              </p>
            </div>
          </div>

          <!-- Modern Comparison (Fun Section) -->
          <div class="bg-indigo-50/80 rounded-xl p-5 border border-indigo-100 mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-2 opacity-10">
              <i data-lucide="smartphone" class="w-16 h-16 text-indigo-900"></i>
            </div>
            <h3 class="flex items-center gap-2 text-sm font-bold text-indigo-900 mb-3 relative z-10">
              <i data-lucide="zap" class="w-4 h-4 text-indigo-600"></i> 現代で言うと？
            </h3>
            <div class="space-y-3 relative z-10">
              <div class="flex gap-3 items-start">
                <span
                  class="bg-white text-indigo-600 text-[10px] font-bold px-2 py-1 rounded shadow-sm border border-indigo-100 shrink-0 mt-0.5">タイプ</span>
                <p id="result-modern" class="text-sm text-slate-700 font-medium"></p>
              </div>
              <div class="flex gap-3 items-start">
                <span
                  class="bg-white text-indigo-600 text-[10px] font-bold px-2 py-1 rounded shadow-sm border border-indigo-100 shrink-0 mt-0.5">もし生きてたら</span>
                <p id="result-if-alive" class="text-sm text-slate-700"></p>
              </div>
            </div>
          </div>

          <!-- Trivia & Stats -->
          <div class="flex flex-col md:flex-row gap-3 items-stretch">
            <div class="flex-1 bg-slate-800 text-slate-200 p-4 rounded-xl flex flex-col justify-center">
              <p class="text-[10px] text-slate-400 mb-1 font-bold uppercase flex items-center gap-1">
                <i data-lucide="info" class="w-3 h-3"></i> 豆知識
              </p>
              <p id="result-fun-fact" class="text-xs leading-relaxed"></p>
            </div>
            <div class="shrink-0 bg-slate-800 p-4 rounded-xl flex flex-col items-center justify-center min-w-[100px]">
              <p class="text-[10px] text-slate-400 mb-1">マニアック度</p>
              <div class="text-2xl font-black text-yellow-400 flex items-end leading-none">
                <span id="result-trivia-level"></span><span
                  class="text-xs text-slate-500 font-normal mb-1 ml-0.5">/100</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer Actions -->
        <div
          class="p-4 bg-white border-t border-slate-200 flex gap-3 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
          <button id="btn-search" onclick=""
            class="flex-1 py-3 rounded-xl border-2 border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 hover:border-slate-300 transition flex items-center justify-center gap-2">
            <i data-lucide="search" class="w-4 h-4"></i> 調べる
          </button>
          <button onclick="startGame()"
            class="flex-[2] py-3 rounded-xl bg-indigo-600 text-white font-bold text-sm hover:bg-indigo-700 shadow-lg hover:shadow-indigo-200 transition flex items-center justify-center gap-2 transform active:scale-95">
            <i data-lucide="rotate-ccw" class="w-4 h-4"></i> もう一度遊ぶ
          </button>
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 bg-slate-50 scroll-smooth pb-32">
      <!-- Messages injected here -->
    </div>

    <!-- Controls -->
    <div id="controls"
      class="hidden absolute bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg z-10">
      <!-- Tabs -->
      <div class="flex overflow-x-auto py-2 px-2 border-b border-slate-100 scrollbar-hide gap-1" id="category-tabs">
        <!-- Tabs injected by JS -->
      </div>

      <!-- Interaction Area -->
      <div class="p-3 h-48 bg-slate-50/50">
        <!-- Preset Questions -->
        <div id="preset-area" class="grid grid-cols-1 gap-2 overflow-y-auto h-full pr-1 hidden"></div>

        <!-- Year Input -->
        <div id="year-area" class="hidden h-full flex flex-col items-center justify-center p-4">
          <p class="text-sm text-slate-500 mb-3">西暦を入力して絞り込み</p>
          <div class="flex items-center gap-2 w-full max-w-xs mb-3">
            <input type="number" id="year-input" placeholder="例: 1600" class="flex-1 p-2 border rounded-lg text-center"
              value="1600">
            <span class="text-sm">年</span>
          </div>
          <div class="flex gap-2 w-full max-w-xs">
            <button onclick="askYear('before')"
              class="flex-1 bg-blue-100 text-blue-700 py-2 rounded-lg hover:bg-blue-200 text-sm font-bold">より前</button>
            <button onclick="askYear('after')"
              class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg hover:bg-red-200 text-sm font-bold">より後</button>
          </div>
        </div>

        <!-- Custom Input -->
        <div id="custom-area" class="hidden h-full flex flex-col items-center justify-center p-2">
          <p class="text-xs text-slate-500 mb-2 flex items-center gap-1"><i data-lucide="sparkles"
              class="w-3 h-3 text-indigo-500"></i> AIに自由に質問</p>
          <div class="flex gap-2 w-full max-w-md">
            <input type="text" id="custom-input" placeholder="質問を入力..."
              class="flex-1 p-2 border border-slate-300 rounded-lg text-sm">
            <button onclick="askCustom()" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700"><i
                data-lucide="send" class="w-4 h-4"></i></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Guess Modal -->
    <div id="guess-modal"
      class="hidden absolute inset-0 z-40 bg-slate-900/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
      <div class="bg-white w-full max-w-md p-4 rounded-t-2xl sm:rounded-2xl flex flex-col max-h-[80vh]">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold">回答する</h3>
          <button onclick="closeGuessModal()" class="p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="overflow-y-auto flex-1 mb-4 border rounded-lg">
          <div id="person-list" class="divide-y divide-slate-100"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- Config & Data ---
    const apiKey = ""; // APIキーを設定

    // --- データ定義の拡張 ---
    // ユーザーから提供されたスキーマ:
    // id,name,name_en,birth_year,death_year,era,region,gender,occupation,
    // major_achievement,historical_significance,famous_quote,personality_trait,
    // fun_fact,modern_comparison,if_alive_today,recommended_for,trivia_level,catchphrase

    // 既存データを拡張し、信長と秀吉は詳細データを適用。他は既存データ+デフォルト値。
    const PERSONS = [
      {
        id: 1,
        name: '織田信長',
        name_en: 'Oda Nobunaga',
        year: 1560, // ゲームロジック用(目安)
        birth_year: 1534,
        death_year: 1582,
        attributes: { region: 'japan', era: 'sengoku', gender: 'male', occupation: 'warrior' },
        // 詳細データ
        occupation_display: '武将・戦国大名',
        major_achievement: '天下統一への道筋を作った。楽市楽座や兵農分離など革新的な政策を実施。',
        famous_quote: '「是非に及ばず」',
        personality_trait: '超革新的で短気、新しいもの好き。常識にとらわれない思考の持ち主。',
        fun_fact: '南蛮文化マニアでマントを着て金平糖を食べていた。地球が丸いことも理解していたと言われる。',
        modern_comparison: 'イーロン・マスク的な破壊的イノベーター',
        if_alive_today: '絶対にスタートアップCEOやってそう、AI開発に夢中になってそう。',
        trivia_level: 95,
        catchphrase: '常識？それ美味しいの？'
      },
      {
        id: 2,
        name: '豊臣秀吉',
        name_en: 'Toyotomi Hideyoshi',
        year: 1585,
        birth_year: 1537,
        death_year: 1598,
        attributes: { region: 'japan', era: 'sengoku', gender: 'male', occupation: 'warrior' },
        // 詳細データ
        occupation_display: '武将・天下人',
        major_achievement: '農民から天下人へと上り詰め、太閤検地や刀狩りで国内を安定させた。',
        famous_quote: '「露と落ち露と消えにしわが身かな」',
        personality_trait: '陽気で社交的、交渉上手（人たらし）。派手好きで黄金の茶室を作った。',
        fun_fact: '指が6本あったという説がある。あだ名は「サル」ではなく「ハゲネズミ」だったことも。',
        modern_comparison: '起業で成功した元バイトリーダー',
        if_alive_today: 'YouTuberかインフルエンサーやってそう、圧倒的トーク力で稼ぐタイプ。',
        trivia_level: 92,
        catchphrase: '農民からの成り上がり、見せたろか！'
      },
      // --- 以下、既存データ（詳細データは簡易版またはnull） ---
      { id: 3, name: '徳川家康', name_en: 'Tokugawa Ieyasu', year: 1600, attributes: { region: 'japan', era: 'edo', gender: 'male', occupation: 'politician' }, occupation_display: '征夷大将軍', catchphrase: '鳴かぬなら鳴くまで待とう' },
      { id: 4, name: '坂本龍馬', name_en: 'Sakamoto Ryoma', year: 1860, attributes: { region: 'japan', era: 'bakumatsu', gender: 'male', occupation: 'warrior' }, occupation_display: '維新志士', catchphrase: '日本の夜明けぜよ' },
      { id: 6, name: '夏目漱石', name_en: 'Natsume Soseki', year: 1900, attributes: { region: 'japan', era: 'modern_jp', gender: 'male', occupation: 'writer' }, occupation_display: '小説家', catchphrase: '吾輩は猫である' },
      { id: 9, name: '紫式部', name_en: 'Murasaki Shikibu', year: 1000, attributes: { region: 'japan', era: 'ancient', gender: 'female', occupation: 'writer' }, occupation_display: '作家・歌人', catchphrase: '世界最古の長編小説作家' },
      { id: 15, name: '手塚治虫', name_en: 'Tezuka Osamu', year: 1970, attributes: { region: 'japan', era: 'modern', gender: 'male', occupation: 'artist' }, occupation_display: '漫画家', catchphrase: 'マンガの神様' },
      { id: 16, name: 'ナポレオン', name_en: 'Napoleon Bonaparte', year: 1804, attributes: { region: 'europe', era: 'modern_world', gender: 'male', occupation: 'warrior' }, occupation_display: 'フランス皇帝', catchphrase: '余の辞書に不可能はない' },
      { id: 17, name: 'クレオパトラ', name_en: 'Cleopatra', year: -30, attributes: { region: 'other', era: 'ancient', gender: 'female', occupation: 'politician' }, occupation_display: 'エジプト女王', catchphrase: '絶世の美女' },
      { id: 18, name: 'ダ・ヴィンチ', name_en: 'Leonardo da Vinci', year: 1500, attributes: { region: 'europe', era: 'medieval', gender: 'male', occupation: 'artist' }, occupation_display: '芸術家・発明家', catchphrase: '万能の天才' },
      { id: 20, name: 'アインシュタイン', name_en: 'Albert Einstein', year: 1920, attributes: { region: 'europe', era: 'modern', gender: 'male', occupation: 'scientist' }, occupation_display: '理論物理学者', catchphrase: '相対性理論の父' },
      { id: 21, name: 'マリー・キュリー', name_en: 'Marie Curie', year: 1910, attributes: { region: 'europe', era: 'modern', gender: 'female', occupation: 'scientist' }, occupation_display: '物理学者・化学者', catchphrase: 'ノーベル賞を2度受賞' },
      { id: 22, name: 'ガンディー', name_en: 'Mahatma Gandhi', year: 1940, attributes: { region: 'asia', era: 'modern', gender: 'male', occupation: 'politician' }, occupation_display: '政治指導者', catchphrase: '非暴力・不服従' },
      { id: 26, name: 'ピカソ', name_en: 'Pablo Picasso', year: 1950, attributes: { region: 'europe', era: 'modern', gender: 'male', occupation: 'artist' }, occupation_display: '画家', catchphrase: '20世紀最大の芸術家' },
      { id: 28, name: 'リンカーン', name_en: 'Abraham Lincoln', year: 1860, attributes: { region: 'america', era: 'modern_world', gender: 'male', occupation: 'politician' }, occupation_display: '第16代アメリカ大統領', catchphrase: '人民の人民による...' }
    ];

    const CATEGORIES = [
      { id: 'custom', name: '自由', icon: 'message-square', color: 'text-indigo-600 bg-indigo-50' },
      { id: 'year', name: '年代', icon: 'calendar-clock', color: 'text-rose-600 bg-rose-50' },
      { id: 'region', name: '地域', icon: 'globe', color: 'text-blue-600 bg-blue-50' },
      { id: 'gender', name: '性別', icon: 'user', color: 'text-pink-600 bg-pink-50' },
      { id: 'occupation', name: '職業', icon: 'briefcase', color: 'text-emerald-600 bg-emerald-50' }
    ];

    const QUESTIONS = [
      { id: 11, categoryId: 'region', text: '日本人ですか？', check: (p) => p.attributes.region === 'japan' },
      { id: 12, categoryId: 'region', text: 'ヨーロッパの人ですか？', check: (p) => p.attributes.region === 'europe' },
      { id: 13, categoryId: 'region', text: 'アメリカの人ですか？', check: (p) => p.attributes.region === 'america' },
      { id: 21, categoryId: 'gender', text: '男性ですか？', check: (p) => p.attributes.gender === 'male' },
      { id: 22, categoryId: 'gender', text: '女性ですか？', check: (p) => p.attributes.gender === 'female' },
      { id: 31, categoryId: 'occupation', text: '武将・軍人ですか？', check: (p) => p.attributes.occupation === 'warrior' },
      { id: 32, categoryId: 'occupation', text: '政治家ですか？', check: (p) => p.attributes.occupation === 'politician' },
      { id: 33, categoryId: 'occupation', text: '芸術家・作家ですか？', check: (p) => ['artist', 'writer'].includes(p.attributes.occupation) },
      { id: 34, categoryId: 'occupation', text: '科学者ですか？', check: (p) => p.attributes.occupation === 'scientist' }
    ];

    // --- State ---
    let targetPerson = null;
    let qCount = 0;
    let hintLeft = 3; // ヒントの残り回数
    let currentCat = 'custom';

    // --- Core Functions ---
    function init() {
      lucide.createIcons();
      renderTabs();
      renderPersonList();
    }

    function startGame() {
      targetPerson = PERSONS[Math.floor(Math.random() * PERSONS.length)];
      console.log("Target:", targetPerson.name); // Debug
      qCount = 0;
      hintLeft = 3; // Reset hints
      updateStats();
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.add('hidden');
      document.getElementById('game-stats').classList.remove('hidden');
      document.getElementById('controls').classList.remove('hidden');
      document.getElementById('chat-container').innerHTML = '';
      addMessage('ai', '歴史上の人物を思い浮かべました。質問してください。', 'neutral');
      switchTab('year');
    }

    function addMessage(type, text, highlight) {
      const div = document.createElement('div');
      const isAi = type === 'ai';
      const colorClass = highlight === 'yes' ? 'bg-green-50 border-green-200' :
        highlight === 'no' ? 'bg-red-50 border-red-200' : 'bg-white border-slate-200';

      div.className = `flex w-full mb-3 ${isAi ? 'justify-start' : 'justify-end'}`;
      div.innerHTML = `
                <div class="flex max-w-[85%] ${isAi ? 'flex-row' : 'flex-row-reverse'} items-end gap-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${isAi ? 'bg-indigo-600 text-white' : 'bg-gray-300'}">
                        <i data-lucide="${isAi ? 'brain-circuit' : 'user'}" class="w-4 h-4"></i>
                    </div>
                    <div class="p-3 rounded-2xl shadow-sm border text-sm ${isAi ? colorClass : 'bg-indigo-600 text-white'}">
                        ${text}
                    </div>
                </div>`;
      document.getElementById('chat-container').appendChild(div);
      lucide.createIcons();
      div.scrollIntoView({ behavior: 'smooth' });
    }

    function updateStats() {
      document.getElementById('q-count').innerText = qCount;

      // ヒントボタンの更新
      const hintBtn = document.getElementById('btn-hint');
      const hintBadge = document.getElementById('hint-badge');
      hintBadge.innerText = hintLeft;

      if (hintLeft <= 0) {
        hintBtn.disabled = true;
        hintBadge.className = "bg-slate-400 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[1.2em] text-center";
      } else {
        hintBtn.disabled = false;
        hintBadge.className = "bg-amber-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[1.2em] text-center";
      }
    }

    // --- Logic: Questions ---
    function handleAsk(text, isYes) {
      qCount++;
      updateStats();
      addMessage('user', text, 'neutral');
      setTimeout(() => {
        const ans = isYes ? 'はい' : 'いいえ';
        addMessage('ai', ans, isYes ? 'yes' : 'no');
      }, 500);
    }

    // 年代質問
    function askYear(type) {
      const inputVal = parseInt(document.getElementById('year-input').value);
      if (!inputVal) return;

      const text = `西暦${inputVal}年より${type === 'before' ? '前' : '後'}ですか？`;
      // ロジック: beforeなら (target < input) が正解ならYes
      let isYes = false;
      if (type === 'before') isYes = targetPerson.year < inputVal;
      else isYes = targetPerson.year > inputVal;

      handleAsk(text, isYes);
    }

    // プリセット質問
    function askPreset(qId) {
      const q = QUESTIONS.find(x => x.id === qId);
      handleAsk(q.text, q.check(targetPerson));
    }

    // 自由質問 (Gemini)
    async function askCustom() {
      const input = document.getElementById('custom-input');
      const text = input.value.trim();
      if (!text) return;
      input.value = '';

      qCount++;
      updateStats();
      addMessage('user', text, 'neutral');

      // 簡易ローディング
      const loadId = 'loading-' + Date.now();
      const div = document.createElement('div');
      div.id = loadId;
      div.className = "text-xs text-slate-400 ml-12 mb-2";
      div.innerText = "考え中...";
      document.getElementById('chat-container').appendChild(div);

      try {
        const prompt = `正解は「${targetPerson.name}」です。ユーザーの質問「${text}」に「はい」「いいえ」「どちらとも言えない」のいずれかで答えて。正解は隠して。`;
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await res.json();
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "エラー";

        document.getElementById(loadId).remove();

        let hl = 'neutral';
        if (reply.includes('はい')) hl = 'yes';
        if (reply.includes('いいえ')) hl = 'no';
        addMessage('ai', reply, hl);
      } catch (e) {
        document.getElementById(loadId).remove();
        addMessage('ai', '通信エラーです', 'neutral');
      }
    }

    // ヒント (Gemini)
    async function askHint() {
      if (hintLeft <= 0) return; // 回数制限

      const btn = document.getElementById('btn-hint');
      btn.disabled = true; // 通信中は一時無効

      addMessage('user', 'ヒントをください', 'neutral');

      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: `正解は「${targetPerson.name}」です。正解を明かさず面白いヒントを日本語で1つ出して。` }] }] })
        });
        const data = await res.json();
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "ヒント生成失敗";
        addMessage('ai', `ヒント: ${reply}`, 'neutral');

        // 成功したら回数を減らす
        hintLeft--;
      } catch (e) { console.log(e); }

      updateStats(); // ボタン状態更新（ここでdisabled制御も含む）
    }

    // --- UI Control ---
    function renderTabs() {
      const container = document.getElementById('category-tabs');
      container.innerHTML = CATEGORIES.map(c => `
                <button onclick="switchTab('${c.id}')" 
                    class="tab-btn px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition-all border ${c.id === currentCat ? c.color + ' border-current' : 'text-slate-500 border-transparent hover:bg-slate-50'}"
                    data-id="${c.id}">
                    <i data-lucide="${c.icon}" class="w-4 h-4"></i> ${c.name}
                </button>
            `).join('');
      lucide.createIcons();
    }

    function switchTab(catId) {
      currentCat = catId;
      renderTabs();

      ['preset-area', 'year-area', 'custom-area'].forEach(id => document.getElementById(id).classList.add('hidden'));

      if (catId === 'custom') {
        document.getElementById('custom-area').classList.remove('hidden');
      } else if (catId === 'year') {
        document.getElementById('year-area').classList.remove('hidden');
      } else {
        // Preset
        const area = document.getElementById('preset-area');
        area.classList.remove('hidden');
        area.innerHTML = QUESTIONS.filter(q => q.categoryId === catId).map(q => `
                    <button onclick="askPreset(${q.id})" class="text-left p-3 border rounded-lg hover:bg-indigo-50 hover:border-indigo-200 text-sm transition-colors bg-white">
                        ${q.text}
                    </button>
                `).join('');
      }
    }

    // --- Guessing Logic ---
    function showGuessModal() {
      document.getElementById('guess-modal').classList.remove('hidden');
    }
    function closeGuessModal() {
      document.getElementById('guess-modal').classList.add('hidden');
    }
    function renderPersonList() {
      // ID順ソート
      const sorted = [...PERSONS].sort((a, b) => a.id - b.id);
      document.getElementById('person-list').innerHTML = sorted.map(p => `
                <button onclick="makeGuess(${p.id})" class="w-full text-left p-3 hover:bg-indigo-50 flex justify-between items-center group">
                    <span class="font-medium text-slate-700">${p.name}</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 group-hover:text-indigo-500"></i>
                </button>
            `).join('');
      lucide.createIcons();
    }
    function makeGuess(id) {
      closeGuessModal();
      const guess = PERSONS.find(p => p.id === id);

      // 正解判定
      if (guess.id === targetPerson.id) {
        // Win
        const p = targetPerson; // エイリアス
        document.getElementById('result-screen').classList.remove('hidden');

        // データ注入
        document.getElementById('result-name').innerText = p.name;
        document.getElementById('result-name-en').innerText = p.name_en || '';
        document.getElementById('result-catchphrase').innerText = p.catchphrase || '歴史の偉人';

        // プロフィール
        const yearText = (p.birth_year && p.death_year) ? `${p.birth_year} - ${p.death_year}` : '不明';
        document.getElementById('result-years').innerText = yearText;
        document.getElementById('result-occupation').innerText = p.occupation_display || '不明';

        // 功績 (ない場合はデフォルト文)
        document.getElementById('result-achievement').innerText = p.major_achievement || `${p.name}として歴史に名を残した。`;

        // 名言・性格
        document.getElementById('result-quote').innerText = p.famous_quote || '（名言データなし）';
        document.getElementById('result-personality').innerText = p.personality_trait || '詳細データなし';

        // 現代風
        document.getElementById('result-modern').innerText = p.modern_comparison || 'インフルエンサー';
        document.getElementById('result-if-alive').innerText = p.if_alive_today || 'すごい人になっている';

        // 豆知識
        document.getElementById('result-fun-fact').innerText = p.fun_fact || '歴史の授業で必ず習う人物です。';
        document.getElementById('result-trivia-level').innerText = p.trivia_level || '50';

        // 検索ボタン
        document.getElementById('btn-search').onclick = () => {
          window.open(`https://www.google.com/search?q=${encodeURIComponent(p.name)}`, '_blank');
        };

        lucide.createIcons();

      } else {
        // Lose (Continue)
        qCount++;
        updateStats();
        addMessage('user', `${guess.name}ですか？`, 'neutral');
        addMessage('ai', '違います。まだ諦めないでください。', 'no');
      }
    }

    // Init
    init();
  </script>
</body>

</html>
